import { MapBuilder } from 'components/map_builder'

import ahoy from 'ahoy.js'
import '<%= File.join(Gem.loaded_specs['cocoon'].full_gem_path, 'app', 'assets', 'javascripts', 'cocoon') %>'
import {} from 'jquery-ujs'

var Turbolinks = require('turbolinks')
Turbolinks.start()

require('<%= File.join(Gem.loaded_specs['turbolinks-form'].full_gem_path, 'app', 'assets', 'javascripts', 'turbolinks-form-core') %>')
require('styles/page.css.scss')
require('bootstrap/dist/js/bootstrap.js')
require('bootstrap-table/dist/bootstrap-table.js')

window.linkSort = function (a, b) {
  a = $(a).text()
  b = $(b).text()

  if (a < b) return -1
  if (a > b) return 1

  return 0
}

var mb = new MapBuilder()
mb.prepare()

document.addEventListener('turbolinks:load', function (event) {
  $.rails.refreshCSRFTokens()
  ahoy.trackView()
  mb.initMap()
  $('[data-toggle="table"]').bootstrapTable()

  $('#contact').bind('cocoon:after-insert', function () {
    $('#contact_select').hide()
    $('#contact .links').hide()
  })
  $('#contact').bind('cocoon:after-remove', function () {
    $('#contact_select').show()
    $('#contact .links').show()
  })
  if ($('.contact-fields').length > 0) {
    $('#contact_select').hide()
    $('#contact .links').hide()
  }

  let elSearch = document.getElementById('search')
  let elQuery = document.getElementById('query')
  if (!elSearch || !elQuery) return

  elSearch.addEventListener('submit', function (event) {
    let query = encodeURIComponent(elQuery.value)
    Turbolinks.visit(`/search?query=${query}`)

    event.preventDefault()
    return false
  })
})
